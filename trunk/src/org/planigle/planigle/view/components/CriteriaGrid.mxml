<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" verticalGap="0">
	<mx:Script>
		<![CDATA[
		import flash.events.KeyboardEvent;
		import flash.events.MouseEvent;
		import mx.collections.ArrayCollection;
		import mx.utils.ObjectUtil;
		import mx.utils.StringUtil;
		import org.planigle.planigle.model.Story;
		import org.planigle.planigle.model.Criterium;

		private const RETURN:int=13;
		private const UP:int=38;
		private const DOWN:int=40;
		private const BACKSPACE:int=8;
		private const DELETE:int=127;
		private const INITIAL_CRITERIA:String = "<Enter criteria here; Press Enter or down arrow to add additional>";

		[Bindable]
		private var criteria:ArrayCollection = new ArrayCollection();
		
        public function clear():void
        {
        	criteria = new ArrayCollection();
        	addNewCriterium(INITIAL_CRITERIA);
        }
                
        protected function addNewCriterium(description:String=""):void
        {
        	var criterium:Criterium = new Criterium();
        	criterium.description=description;
        	criteria.addItem(criterium);
        }
	
        public function set story(story:Story):void
        {
        	var newCriteria:ArrayCollection = new ArrayCollection();
        	for each(var criterium:Criterium in story.criteria)
        		newCriteria.addItem(ObjectUtil.copy(criterium)); // Use copies so that they can be thrown away if canceled.
        	criteria = newCriteria;
        	if (newCriteria.length == 0)
        		addNewCriterium(INITIAL_CRITERIA);
        }
        
        public function filterDone():void
        {
        	var newCriteria:ArrayCollection = new ArrayCollection();
        	for each(var criterium:Criterium in criteria)
        	{
        		if (criterium.statusCode != Criterium.DONE)
	        		newCriteria.addItem(criterium);
        	}
        	criteria = newCriteria;
        	if (newCriteria.length == 0)
        		addNewCriterium(INITIAL_CRITERIA);
        }
        
        public function get acceptanceCriteria():String
        {
        	var string:String = "";
        	for each(var criterium:Criterium in criteria)
        	{
        		if (StringUtil.trim(criterium.description) != "" && criterium.description != INITIAL_CRITERIA)
        		{
	        		if (string != "")
	        			string += "\r";
	        		if (criteria.length > 1)
		        		string += "-";
	        		string += criterium.description;
	        		if (criterium.statusCode == Criterium.DONE)
	        			string += " (Done)";
	        	}
        	}
        	return string;
        }

		public function handleKeystroke(event:KeyboardEvent):void
		{
			if ((event.charCode == RETURN || event.keyCode == DOWN) && criteriaGrid.selectedIndex == criteria.length - 1)
			{
				addNewCriterium();
				criteriaGrid.editedItemPosition = {'columnIndex': 1, 'rowIndex': criteriaGrid.selectedIndex + 1};
			}
			else if (event.keyCode == UP && criteriaGrid.selectedIndex > 0)
				criteriaGrid.editedItemPosition = {'columnIndex': 1, 'rowIndex': criteriaGrid.selectedIndex - 1};
			else if (event.keyCode == DOWN && criteriaGrid.selectedIndex < criteria.length - 1)
				criteriaGrid.editedItemPosition = {'columnIndex': 1, 'rowIndex': criteriaGrid.selectedIndex + 1};
		}

        public function iconFor(data:Object):Class
        {
        	return data.statusCode == 0 ? parentApplication.imgNotDone : parentApplication.imgDone;
        }
        
        public function toggleStatus(criterium:Object):void
        {
    		criterium.toggleStatus();
        }
        
        public function deleteItem(criterium:Object):void
        {
    		criteria.removeItemAt(criteria.getItemIndex(criterium));
        	if (criteria.length == 0)
        		addNewCriterium(INITIAL_CRITERIA);
        }
        
        public function selectFirstItem():void
        {
        	criteriaGrid.selectedIndex = criteria.length - 1;
			criteriaGrid.editedItemPosition = {'columnIndex': 1, 'rowIndex': criteriaGrid.selectedIndex};
        }
		]]>
	</mx:Script>
	<mx:TextArea height="0" id="criteriaDescription" text="{criteriaGrid.selectedItem == null ? '' : criteriaGrid.selectedItem.description}" change="criteriaGrid.selectedItem.description = criteriaDescription.text"/>
	<mx:DataGrid id="criteriaGrid" variableRowHeight="true" dataProvider="{criteria}" dragEnabled="true" dropEnabled="true" dragMoveEnabled="true" allowMultipleSelection="true" showHeaders="false" editable="true" verticalGridLines="false" keyUp="handleKeystroke(event)" width="100%" height="100%">
		<mx:columns>
			<mx:DataGridColumn resizable="false" editable="false" width="16" textAlign="center"> 
				<mx:itemRenderer>
					<mx:Component>
						<mx:Box direction="horizontal" horizontalGap="0" width="100%">
							<mx:LinkButton paddingLeft="0" paddingRight="0" id="criteriaBtnToggle" icon="{outerDocument.iconFor(data)}" toolTip="Toggle Status" click="outerDocument.toggleStatus(data);"/>
						</mx:Box>
					</mx:Component>
				</mx:itemRenderer>
			</mx:DataGridColumn>
			<mx:DataGridColumn resizable="false" width="448" dataField="description" wordWrap="true" editable="true"/>
			<mx:DataGridColumn resizable="false" editable="false" width="16" textAlign="center"> 
				<mx:itemRenderer>
					<mx:Component>
						<mx:Box direction="horizontal" horizontalGap="0" width="100%">
							<mx:LinkButton paddingLeft="0" paddingRight="0" id="criteriaBtnDelete" icon="{parentApplication.imgCross}" toolTip="Delete" click="outerDocument.deleteItem(data);"/>
						</mx:Box>
					</mx:Component>
				</mx:itemRenderer>
			</mx:DataGridColumn>
		</mx:columns>
	</mx:DataGrid>
</mx:VBox>